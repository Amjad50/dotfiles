{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
# ============================================================================
# Multi-distro package installer for chezmoi (Tags-based)
# Automatically detects available package managers and installs packages
# based on machine tags (dev, laptop, gui, headless, etc.)
# ============================================================================

set -e

{{ $hostname := .chezmoi.hostname -}}
{{ $machine := dig "machines" $hostname dict . -}}
{{ $distro := dig "distro" "" $machine -}}
{{ $tagsConfigured := dig "tags" list $machine -}}
{{ $pkgs := dig "packages" dict $machine -}}
{{ $repos := dig "repositories" dict $machine -}}
{{ $tagPackages := .tag_packages -}}

{{- /* Auto-apply 'default' tag + configured tags */ -}}
{{ $tags := concat (list "default") $tagsConfigured | uniq -}}

HOSTNAME="{{ .chezmoi.hostname }}"

{{ if $machine -}}
echo "→ Installing packages for: $HOSTNAME"
echo "  • Distro: $distro"
echo "  • Tags: {{ join ", " $tags }}"
{{ else -}}
echo "⚠️  No machine-specific configuration found for: $HOSTNAME"
echo "→ Installing default packages only..."
{{ end -}}
echo ""

{{- /* Collect packages from tags for each distro */ -}}
{{ $dnfFromTags := list -}}
{{ $pacmanFromTags := list -}}
{{ $aptFromTags := list -}}

{{- range $tag := $tags }}
  {{- $tagData := dig $tag dict $tagPackages }}
  {{- $dnfFromTags = concat $dnfFromTags (dig "common" list $tagData) (dig "fedora" list $tagData) }}
  {{- $pacmanFromTags = concat $pacmanFromTags (dig "common" list $tagData) (dig "arch" list $tagData) }}
  {{- $aptFromTags = concat $aptFromTags (dig "common" list $tagData) (dig "debian" list $tagData) }}
{{- end }}

{{- /* Combine tag packages + machine-specific packages */ -}}
{{ $dnfSpecific := dig "dnf" list $pkgs -}}
{{ $dnfToInstall := concat $dnfFromTags $dnfSpecific | uniq -}}

{{ $pacmanSpecific := dig "pacman" list $pkgs -}}
{{ $pacmanToInstall := concat $pacmanFromTags $pacmanSpecific | uniq -}}

{{ $aptSpecific := dig "apt" list $pkgs -}}
{{ $aptToInstall := concat $aptFromTags $aptSpecific | uniq -}}

# ============================================================================
# DNF (Fedora, RHEL, CentOS, etc.)
# ============================================================================
if command -v dnf &>/dev/null; then
  echo "→ DNF package manager detected"

  {{ $dnfRepos := dig "dnf" list $repos -}}
  {{ if $dnfRepos -}}
  echo "  → Adding DNF repositories..."
  FEDORA_VER=$(rpm -E %fedora)
  {{ range $dnfRepos -}}
  sudo dnf config-manager addrepo --from-repofile={{ . }}
  {{ end -}}
  {{ end -}}

  {{ if $dnfToInstall -}}
  echo "  → Installing {{ len $dnfToInstall }} DNF packages..."
  sudo dnf install -y {{ join " " $dnfToInstall }}
  {{ else -}}
  echo "  → No DNF packages to install"
  {{ end -}}
  echo ""
fi

# ============================================================================
# Pacman (Arch, Manjaro, EndeavourOS, etc.)
# ============================================================================
if command -v pacman &>/dev/null; then
  echo "→ Pacman package manager detected"

  {{ $pacmanRepos := dig "pacman" list $repos -}}
  {{ if $pacmanRepos -}}
  echo "  → Setting up Pacman repositories..."
  {{ range $pacmanRepos -}}
{{ . }}
  {{ end -}}
  {{ end -}}

  {{ if $pacmanToInstall -}}
  echo "  → Installing {{ len $pacmanToInstall }} Pacman packages..."
  sudo pacman -S --needed --noconfirm {{ join " " $pacmanToInstall }}
  {{ else -}}
  echo "  → No Pacman packages to install"
  {{ end -}}
  echo ""
fi

# ============================================================================
# APT (Debian, Ubuntu, Linux Mint, etc.)
# ============================================================================
if command -v apt &>/dev/null; then
  echo "→ APT package manager detected"

  {{ $aptRepos := dig "apt" list $repos -}}
  {{ if $aptRepos -}}
  echo "  → Adding APT repositories..."
  {{ range $aptRepos -}}
  sudo add-apt-repository -y {{ . }}
  {{ end -}}
  sudo apt update
  {{ end -}}

  {{ if $aptToInstall -}}
  echo "  → Installing {{ len $aptToInstall }} APT packages..."
  sudo apt install -y {{ join " " $aptToInstall }}
  {{ else -}}
  echo "  → No APT packages to install"
  {{ end -}}
  echo ""
fi

# ============================================================================
# Flatpak (Universal across distros)
# ============================================================================
{{ $flatpakPkgs := dig "flatpak" list $pkgs -}}
{{ if $flatpakPkgs -}}
if command -v flatpak &>/dev/null; then
  echo "→ Flatpak detected"
  echo "  → Installing {{ len $flatpakPkgs }} Flatpak packages..."
  flatpak install -y flathub {{ join " " $flatpakPkgs }}
  echo ""
else
  echo "⚠️  Flatpak not found, skipping Flatpak packages"
  echo ""
fi
{{ end -}}

echo "✅ Package installation complete for $HOSTNAME"
{{ end -}}
